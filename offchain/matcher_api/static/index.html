<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Singularity Off-Chain MVP</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
      .row { margin-bottom: 12px; }
      input, select, button { padding: 6px; }
      #log { height: 240px; overflow: auto; border: 1px solid #ddd; padding: 8px; }
      .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
      h2 { margin-top: 24px; }
    </style>
  </head>
  <body>
    <h1>Singularity</h1>

    <div class="grid">
      <div>
        <h2>Place Order</h2>
        <div class="row"><label>Trader </label><input id="trader" value="Alice" /></div>
        <div class="row"><label>Side </label><select id="side"><option>buy</option><option>sell</option></select></div>
        <div class="row"><label>Price </label><input id="price" type="number" value="100" /></div>
        <div class="row"><label>Qty </label><input id="qty" type="number" value="1000" /></div>
        <div class="row"><label>Leverage </label><input id="lev" type="number" value="10" /></div>
        <div class="row"><label>TTL (s)</label><input id="ttl" type="number" value="86400" /></div>
        <div class="row"><label>Limit </label><input id="is_limit" type="checkbox" checked /></div>
        <div class="row"><button id="place">Place</button></div>
      </div>
      <div>
        <h2>Oracle & Liquidation</h2>
        <div class="row"><label>Mark Price </label><input id="mark" type="number" value="100" /></div>
        <div class="row"><button id="simulate_liq">Simulate Liquidation Loop (mock)</button></div>
      </div>
    </div>

    <h2>Account</h2>
    <div class="row"><label>Trader </label><input id="acct_trader" value="Alice" /></div>
    <div class="row"><label>Amount </label><input id="acct_amount" type="number" value="20000" /></div>
    <div class="row">
      <button id="deposit_btn">Deposit</button>
      <button id="withdraw_btn" style="margin-left:8px;">Withdraw</button>
    </div>

    <h2>Live Stream</h2>
    <div style="display:flex; gap:20px;">
      <div style="flex:1;">
        <div><strong>$singu Price:</strong> <span id="singu_price">-</span></div>
        <div><strong>Last Match:</strong> <span id="last_match">None</span></div>
        <div><strong>Last Liquidation:</strong> <span id="last_liq">None</span></div>
      </div>
      <div style="flex:2;">
        <div id="log" aria-label="event-log"></div>
      </div>
    </div>

    <h2>Positions & Health</h2>
    <div>
      <table id="state_table" border="1" cellspacing="0" cellpadding="6">
        <thead>
          <tr>
            <th>Trader</th>
            <th>Collateral</th>
            <th>Locked</th>
            <th>Qty</th>
            <th>Entry</th>
            <th>PnL</th>
            <th>Health (bps)</th>
            <th>Nonce</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px;">Mark: <span id="mark_view">-</span></div>
    </div>

    <script>
      const log = (m) => { const el = document.getElementById('log'); el.innerText += `\n${m}`; el.scrollTop = el.scrollHeight; };

      document.getElementById('place').onclick = async () => {
        const payload = {
          trader: document.getElementById('trader').value,
          side: document.getElementById('side').value,
          price: Number(document.getElementById('price').value),
          qty: Number(document.getElementById('qty').value),
          leverage: Number(document.getElementById('lev').value),
          ttl_secs: Number(document.getElementById('ttl').value),
          is_limit: document.getElementById('is_limit').checked
        };
        const res = await fetch('/orders', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const json = await res.json();
        log('Order placed id=' + json.id);
      };

      function connectStream() {
        const ws = new WebSocket(`ws://${location.host}/ws`);
        ws.onopen = () => log('WS connected');
        ws.onmessage = (ev) => {
          try {
            const j = JSON.parse(ev.data);
            if (j.event === 'oracle') {
              document.getElementById('singu_price').innerText = j.price;
              log(`Oracle tick $singu=${j.price}`);
            } else if (j.event === 'match') {
              document.getElementById('last_match').innerText = `${j.qty}@${j.price} ${j.buy_trader} vs ${j.sell_trader}`;
              log(`Match: ${j.qty}@${j.price} ${j.buy_trader} vs ${j.sell_trader}`);
            } else if (j.event === 'liquidation') {
              document.getElementById('last_liq').innerText = `${j.trader} at ${j.mark}`;
              log(`Liquidation: trader=${j.trader} mark=${j.mark}`);
            }
          } catch(e) { /* ignore parse errors */ }
        };
        ws.onclose = () => { log('WS disconnected, retrying in 2s'); setTimeout(connectStream, 2000); };
      }
      connectStream();

        // Oracle price update (mock)
      document.getElementById('simulate_liq').onclick = async () => {
        const newMark = Number(document.getElementById('mark').value);
        await fetch('/oracle', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ price: newMark }) });
        log('Oracle update requested');
      };

      // Deposit / Withdraw actions
      document.getElementById('deposit_btn').onclick = async () => {
        const trader = document.getElementById('acct_trader').value;
        const amount = Number(document.getElementById('acct_amount').value);
        const res = await fetch('/deposit', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ trader, amount }) });
        const j = await res.json();
        log(`Deposit ${amount} for ${trader}: ${JSON.stringify(j)}`);
        if (typeof refreshState === 'function') refreshState();
      };

      document.getElementById('withdraw_btn').onclick = async () => {
        const trader = document.getElementById('acct_trader').value;
        const amount = Number(document.getElementById('acct_amount').value);
        const res = await fetch('/withdraw', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ trader, amount }) });
        const j = await res.json();
        log(`Withdraw ${amount} for ${trader}: ${JSON.stringify(j)}`);
        if (typeof refreshState === 'function') refreshState();
      };

      async function refreshState() {
        try {
          const res = await fetch('/state');
          const j = await res.json();
          document.getElementById('mark_view').innerText = j.mark;
          const tbody = document.querySelector('#state_table tbody');
          tbody.innerHTML = '';
          for (const t of j.traders) {
            const tr = document.createElement('tr');
            const cells = [t.trader, t.collateral, t.locked_margin, t.qty, t.entry_price, t.pnl, t.health_bps, t.nonce];
            for (const c of cells) {
              const td = document.createElement('td');
              td.textContent = String(c);
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          }
        } catch (e) {
          
        }
      }
      setInterval(refreshState, 1500);
      refreshState();
    </script>
  </body>
</html>
